# Dice Poker Roguelike 開発プロセス

## 概要
「6ダイス・ポーカー」を基盤とした、10フロア構成のミニマルローグライク。リソース（ロール回数・キープ回数）の管理が鍵となる戦略的戦闘ゲーム。

## 設計思想 (v1.1)
- **制限の美学**: 単なる運ゲーではなく、限られた「キープ操作（3回）」の中でどのダイスを確定させるかというジレンマを生み出す。
- **データ駆動**: パークや敵の定義をオブジェクト化し、拡張性と保守性を高める。
- **ミニマリズム**: 複雑なアニメーションを排し、状態の変化（HP減少、役の確定）を明確に伝える。

## 技術的アプローチ
- `GameState` オブジェクトによる単一状態管理。
- 役判定は優先順位に基づき一意に結果を返すように実装。
- パークはフック (`onTurnStart` 等) を持つオブジェクトとして定義。

## プロセス記録
### 2026-01-17: ローグライク化開始
- 要件 v1.1 に基づくディレクトリ `dice_poker/game` の作成。
- リソース制限（rollsLeft/keepsLeft）のロジック設計。

### 2026-01-17: ロジックの安定化とバグ修正
- Straight 判定の厳密化（連続最大長による判定）。
- `hasRolledThisTurn` フラグによるステート管理の強化。
- `updateUI` からの副作用排除（`previewDamage` の導入）。
- ボスの特殊能力（ロール回数減少）の実装と意図表示の追加。
- Fisher-Yates シャッフルによるパーク選択のランダム性改善。

### 2026-01-17: 最終安定化と致命的バグの修正
- **反射勝利判定**: `thorns`（棘）などの反射ダメージで敵が死亡した際、即座に勝利処理が走るよう修正。
- **HPクランプ**: ターン開始および勝利時に、HPが最大値を上回らないよう常に `Math.min` で制限。
- **ロールカウント**: `rollCountThisTurn` を導入し、ロール回数増減パークの影響を受けない正確な「初回ロール判定」を実現。
- **博徒のチラつき防止**: `onDamageConfirmed` フックを導入。確率によるダメージ加算を「確定ボタン押下時」のみに限定し、UIプレビュー（`previewDamage`）での再計算による値の変動を解消。

### 2026-01-17: UI/UX の質的向上
- **プレイヤーHP視覚化**: バー表示と数値表示の統合。
- **パークアイコン列**: 蓄積した力を常時確認可能に（ツールチップ対応）。
- **ログの可読性向上**: ターン跨ぎの透明度減衰により、現在の戦況に集中できる設計。
- **ルールブック**: インゲームで役やパーク仕様を確認できる機能の実装。
